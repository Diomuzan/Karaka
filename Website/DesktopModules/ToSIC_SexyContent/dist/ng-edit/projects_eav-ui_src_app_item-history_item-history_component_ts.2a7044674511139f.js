"use strict";(self.webpackChunkeav_ui=self.webpackChunkeav_ui||[]).push([["projects_eav-ui_src_app_item-history_item-history_component_ts"],{6737:(tt,v,l)=>{l.r(v),l.d(v,{ItemHistoryComponent:()=>Q});var h=l(8071),g=l(3839),C=l(9736);function w(n,i,e){const o=JSON.parse(n.Json).Entity.Attributes,a="live"===e?function Z(n){let i=n[0];for(const e of n)e.VersionNumber<=i.VersionNumber||(i=e);return i}(i):i.find(r=>r.VersionNumber===n.VersionNumber-1),s=a?JSON.parse(a.Json).Entity.Attributes:null,c=[];return null!=o&&Object.entries(o).forEach(([r,d])=>{Object.keys(d).forEach(m=>{null==c.find(_=>_.name===m&&_.dataType===r)&&c.push({name:m,dataType:r})})}),null!=s&&Object.entries(s).forEach(([r,d])=>{Object.keys(d).forEach(m=>{null==c.find(_=>_.name===m&&_.dataType===r)&&c.push({name:m,dataType:r})})}),c.map(r=>{const d=o?.[r.dataType]?.[r.name],m=s?.[r.dataType]?.[r.name];return{name:r.name,dataType:r.dataType,change:x(d,m,!0),values:A(d,m)}})}function A(n,i){const e=[];return null!=n&&Object.keys(n).forEach(a=>{e.includes(a)||e.push(a)}),null!=i&&Object.keys(i).forEach(a=>{e.includes(a)||e.push(a)}),e.map(a=>{const s=n?.[a],c=i?.[a];return{langKey:a,value:s,oldValue:c,change:x(s,c)}})}function x(n,i,e=!1){let o;return e&&("object"==typeof n&&(n=f(n)),"object"==typeof i&&(i=f(i))),o=null!=n&&null!=i?JSON.stringify(n)!==JSON.stringify(i)?"changed":"none":null!=n?"new":"deleted",o}function f(n){return"object"!=typeof n?n:Object.keys(n).sort().reduce((i,e)=>({...i,[e]:n[e]}),{})}var H=l(8702),t=l(9039),O=l(6861),$=l(91),N=l(9409),S=l(9498),y=l(895),F=l(6515),u=l(5787),M=l(6618),P=l(1268),z=l(6355),U=l(257),I=l(6575);function j(n,i){if(1&n){const e=t.EpF();t.TgZ(0,"div",9)(1,"mat-form-field",10)(2,"mat-select",11),t.NdJ("selectionChange",function(a){t.CHM(e);const s=t.oxw(2);return t.KtG(s.compareChange(a.value))}),t.TgZ(3,"mat-option",12),t._uU(4,"Compare with: Previous"),t.qZA(),t.TgZ(5,"mat-option",13),t._uU(6,"Compare with: Live"),t.qZA()()()()}if(2&n){const e=t.oxw();t.xp6(2),t.Q6J("value",e.compareWith)}}function E(n,i){1&n&&(t.TgZ(0,"div"),t._uU(1,"Loading..."),t.qZA())}function J(n,i){1&n&&(t.TgZ(0,"div"),t._uU(1,"No previous versions of this item found"),t.qZA())}function V(n,i){if(1&n&&t._uU(0),2&n){const e=t.oxw().$implicit;t.hij(" ",null==e.values[0]?null:e.values[0].value," ")}}function G(n,i){if(1&n&&(t.TgZ(0,"div"),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.Gre("eav-history-",e.change,""),t.xp6(1),t.hij(" ","deleted"===e.change?e.oldValue:e.value," ")}}function Y(n,i){if(1&n&&(t.TgZ(0,"div",27),t._uU(1),t.qZA(),t.TgZ(2,"div",28),t._uU(3),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.Oqu(e.value),t.xp6(2),t.Oqu(e.oldValue)}}function q(n,i){if(1&n&&(t.TgZ(0,"div",24)(1,"div"),t._uU(2),t.qZA(),t.TgZ(3,"div",25),t.YNc(4,G,2,4,"div",26)(5,Y,4,2),t.qZA()()),2&n){const e=i.$implicit;t.xp6(1),t.Gre("eav-detail-row__label eav-history-",e.change,""),t.xp6(1),t.hij("",e.langKey,":"),t.xp6(2),t.um2(4,"changed"!==e.change?4:-1),t.xp6(1),t.um2(5,"changed"===e.change?5:-1)}}function L(n,i){if(1&n&&(t.TgZ(0,"div",23),t.SjG(1,q,6,6,"div",29,t.x6l),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.wJu(e.values)}}function K(n,i){if(1&n){const e=t.EpF();t.TgZ(0,"div",19)(1,"div",20),t.NdJ("click",function(){const s=t.CHM(e).$implicit,c=t.oxw(2).$implicit,p=t.oxw(3);return t.KtG(p.attributeExpandedToggle(c.versionNumber,s.name))}),t.TgZ(2,"div"),t._uU(3),t.qZA(),t.TgZ(4,"div"),t.YNc(5,V,1,1),t.qZA(),t.TgZ(6,"div",21)(7,"i"),t._uU(8),t.qZA()()(),t.YNc(9,L,3,0,"div",22),t.qZA()}if(2&n){const e=i.$implicit,o=t.oxw(2).$implicit,a=t.oxw(3);t.xp6(2),t.Gre("eav-row-main__label eav-history-",e.change,""),t.xp6(1),t.hij(" ",e.name," "),t.xp6(1),t.Gre("eav-row-main__value eav-history-",e.change,""),t.xp6(1),t.um2(5,a.expandedAttributes[o.versionNumber+e.name]?-1:5),t.xp6(3),t.hij("[",e.dataType,"]"),t.xp6(1),t.um2(9,a.expandedAttributes[o.versionNumber+e.name]?9:-1)}}function B(n,i){if(1&n){const e=t.EpF();t.TgZ(0,"button",30),t.NdJ("click",function(){t.CHM(e);const a=t.oxw(2).$implicit,s=t.oxw(3);return t.KtG(s.restore(a.changeSetId))}),t._uU(1," Restore "),t.qZA()}}function W(n,i){if(1&n&&(t.SjG(0,K,10,10,"div",31,t.x6l),t.TgZ(2,"div",17),t.YNc(3,B,2,0,"button",18),t.qZA()),2&n){const e=t.oxw().$implicit;t.wJu(e.attributes),t.xp6(3),t.um2(3,e.isLastVersion?-1:3)}}function k(n,i){if(1&n){const e=t.EpF();t.TgZ(0,"mat-expansion-panel",15),t.NdJ("expandedChange",function(a){const c=t.CHM(e).$implicit,p=t.oxw(3);return t.KtG(p.panelExpandedChange(a,c.versionNumber))}),t.TgZ(1,"mat-expansion-panel-header")(2,"mat-panel-title"),t._uU(3),t.qZA(),t.TgZ(4,"mat-panel-description"),t._uU(5),t.ALo(6,"date"),t.qZA()(),t.YNc(7,W,4,1,"div",16),t.qZA()}if(2&n){const e=i.$implicit,o=t.oxw(3);t.Q6J("expanded",o.expandedPanels[e.versionNumber]),t.xp6(3),t.hij("Version ",e.versionNumber,""),t.xp6(2),t.Oqu(t.xi3(6,4,e.timeStamp,"yyyy-MM-dd hh:mm")),t.xp6(2),t.um2(7,o.expandedPanels[e.versionNumber]?7:-1)}}function D(n,i){if(1&n&&(t.TgZ(0,"mat-accordion",14),t.SjG(1,k,8,7,"mat-expansion-panel",32,t.x6l),t.qZA()),2&n){const e=t.oxw();t.xp6(1),t.wJu(e.historyItems)}}function R(n,i){if(1&n){const e=t.EpF();t.TgZ(0,"mat-paginator",33),t.NdJ("page",function(a){t.CHM(e);const s=t.oxw(2);return t.KtG(s.pageChange(a))}),t.qZA()}if(2&n){const e=t.oxw(),o=t.oxw();t.Q6J("length",e.length)("pageSize",e.pageSize)("pageSizeOptions",o.pageSizeOptions)}}function X(n,i){if(1&n){const e=t.EpF();t.TgZ(0,"div",1)(1,"div",2)(2,"div",3),t._uU(3,"Item History"),t.qZA(),t.TgZ(4,"button",4),t.NdJ("click",function(){t.CHM(e);const a=t.oxw();return t.KtG(a.closeDialog())}),t.TgZ(5,"mat-icon"),t._uU(6,"close"),t.qZA()()(),t.TgZ(7,"div",5)(8,"p"),t._uU(9,"Check version history for this item and restore the version you need."),t.qZA(),t.YNc(10,j,7,1,"div",6),t.TgZ(11,"div"),t.YNc(12,E,2,0,"div")(13,J,2,0,"div")(14,D,3,0,"mat-accordion",7),t.qZA(),t.YNc(15,R,1,3,"mat-paginator",8),t.qZA()()}2&n&&(t.xp6(10),t.um2(10,(null==i.historyItems?null:i.historyItems.length)>0?10:-1),t.xp6(2),t.um2(12,null===i.historyItems?12:-1),t.xp6(1),t.um2(13,0===(null==i.historyItems?null:i.historyItems.length)?13:-1),t.xp6(1),t.um2(14,(null==i.historyItems?null:i.historyItems.length)>0?14:-1),t.xp6(1),t.um2(15,(null==i.historyItems?null:i.historyItems.length)>0?15:-1))}let Q=(()=>{class n{constructor(e,o,a,s){this.dialogRef=e,this.route=o,this.versionsService=a,this.snackBar=s,this.hostClass="dialog-component",this.pageSizeOptions=[10,20,50],this.expandedPanels={},this.expandedAttributes={},this.itemId=parseInt(this.route.snapshot.paramMap.get("itemId"),10),this.versions$=new h.X(null),this.page$=new h.X(1),this.pageSize$=new h.X(this.pageSizeOptions[0]),this.compareWith$=new h.X("live"),this.historyItems$=(0,g.a)([this.versions$,this.page$,this.pageSize$,this.compareWith$]).pipe((0,C.U)(([c,p,r,d])=>function b(n,i,e,o){return null==n||null==i||null==e||null==o?null:function T(n,i,e){return n.map(o=>({changeSetId:o.ChangeSetId,attributes:w(o,i,e),historyId:o.HistoryId,timeStamp:o.TimeStamp,user:o.User,versionNumber:o.VersionNumber,isLastVersion:!i.some(s=>s.VersionNumber===o.VersionNumber+1)}))}(n.slice((i-1)*e,i*e),n,o)}(c,p,r,d))),this.viewModel$=(0,g.a)([this.versions$,this.historyItems$,this.pageSize$,this.compareWith$]).pipe((0,C.U)(([c,p,r,d])=>({length:c?.length,historyItems:p,pageSize:r,compareWith:d})))}ngOnInit(){this.versionsService.fetchVersions(this.itemId).subscribe(e=>{this.versions$.next(e)})}ngOnDestroy(){this.versions$.complete(),this.page$.complete(),this.pageSize$.complete(),this.compareWith$.complete()}closeDialog(){this.dialogRef.close()}compareChange(e){this.compareWith$.next(e)}panelExpandedChange(e,o){this.expandedPanels[o]=e}attributeExpandedToggle(e,o){this.expandedAttributes[e+o]=!this.expandedAttributes[e+o]}pageChange(e){const o=e.pageIndex+1;o!==this.page$.value&&(this.expandedPanels={},this.expandedAttributes={},this.page$.next(o));const a=e.pageSize;a!==this.pageSize$.value&&this.pageSize$.next(a)}restore(e){this.snackBar.open("Restoring previous version..."),this.versionsService.restore(this.itemId,e).subscribe(o=>{this.snackBar.open("Previous version restored. Will reload edit dialog",null,{duration:3e3}),this.dialogRef.close({refreshEdit:!0})})}static#t=this.\u0275fac=function(o){return new(o||n)(t.Y36(O.so),t.Y36($.gz),t.Y36(H.Z),t.Y36(N.ux))};static#e=this.\u0275cmp=t.Xpm({type:n,selectors:[["app-item-history"]],hostVars:1,hostBindings:function(o,a){2&o&&t.Ikx("className",a.hostClass)},decls:2,vars:3,consts:[["class","eav-dialog eav-no-scrollbar"],[1,"eav-dialog","eav-no-scrollbar"],[1,"eav-dialog-header"],[1,"eav-dialog-header__title"],["mat-icon-button","","tippy","Close dialog",3,"click"],[1,"eav-dialog-content"],["class","eav-compare-box"],["multi","","class","eav-history-tables"],["color","accent","showFirstLastButtons","true",3,"length","pageSize","pageSizeOptions"],[1,"eav-compare-box"],["color","accent",1,"eav-form-field","eav-compare-box__dropdown"],["name","Scope",3,"value","selectionChange"],["value","previous"],["value","live"],["multi","",1,"eav-history-tables"],[3,"expanded","expandedChange"],["class","eav-row-actions"],[1,"eav-row-actions"],["mat-raised-button","","color","accent"],[1,"eav-table-row"],[1,"eav-table-row__main","eav-row-main",3,"click"],[1,"eav-row-main__type"],["class","eav-table-row__details"],[1,"eav-table-row__details"],[1,"eav-detail-row"],[1,"eav-detail-row__value"],[3,"class"],[1,"eav-history-new"],[1,"eav-history-deleted","eav-history-deleted__value"],["class","eav-detail-row"],["mat-raised-button","","color","accent",3,"click"],["class","eav-table-row"],[3,"expanded"],["color","accent","showFirstLastButtons","true",3,"length","pageSize","pageSizeOptions","page"]],template:function(o,a){if(1&o&&(t.YNc(0,X,16,5,"div",0),t.ALo(1,"async")),2&o){let s;t.um2(0,(s=t.lcZ(1,1,a.viewModel$))?0:-1,s)}},dependencies:[S.$,y.lW,y.RK,F.Hw,u.pp,u.ib,u.yz,u.yK,u.u4,M.NW,P.KE,z.gD,U.ey,I.Ov,I.uU],styles:[".eav-compare-box[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;align-items:flex-end;height:40px}.eav-compare-box__dropdown[_ngcontent-%COMP%]{width:192px;margin-top:-14px;font-size:14px;height:auto}.eav-accordion[_ngcontent-%COMP%]{display:block;padding:4px 0}.eav-expansion-panel-header[_ngcontent-%COMP%], .eav-table-row[_ngcontent-%COMP%]{font-size:14px}.eav-table-row__main[_ngcontent-%COMP%]{display:flex}.eav-table-row__details[_ngcontent-%COMP%]{display:block}.eav-row-main[_ngcontent-%COMP%]{cursor:pointer;padding:4px 0}.eav-row-main__label[_ngcontent-%COMP%]{width:160px;flex:0 0 auto}.eav-row-main__value[_ngcontent-%COMP%]{flex:1 1 auto}.eav-row-main__type[_ngcontent-%COMP%]{flex:0 0 auto;font-size:12px}.eav-row-main__type[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]:not(:last-of-type){margin-right:2px}.eav-detail-row[_ngcontent-%COMP%]{display:flex;padding-bottom:4px;cursor:default}.eav-detail-row__label[_ngcontent-%COMP%]{width:160px;flex:0 0 auto}.eav-detail-row__value[_ngcontent-%COMP%]{flex:1 1 auto}.eav-row-actions[_ngcontent-%COMP%]{margin-top:16px;display:flex;justify-content:flex-end}"]})}return n})()}}]);
//# sourceMappingURL=https://sources.2sxc.org/17.01.05/dist/ng-edit/projects_eav-ui_src_app_item-history_item-history_component_ts.2a7044674511139f.js.map